

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pygmin.transition_states._nebdriver &mdash; pygmin 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/scipy.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="pygmin 0.1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../../np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">pygmin 0.1 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pygmin.transition_states._nebdriver</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">pygmin.transition_states</span> <span class="kn">import</span> <span class="n">NEB</span><span class="p">,</span> <span class="n">NEBPar</span>
<span class="kn">from</span> <span class="nn">pygmin.transition_states._NEB</span> <span class="kn">import</span> <span class="n">distance_cart</span>
<span class="kn">from</span> <span class="nn">interpolate</span> <span class="kn">import</span> <span class="n">InterpolatedPath</span><span class="p">,</span> <span class="n">interpolate_linear</span>
<span class="kn">from</span> <span class="nn">pygmin.utils.events</span> <span class="kn">import</span> <span class="n">Signal</span>

<span class="nb">all</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;NEBDriver&quot;</span><span class="p">]</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&quot;pygmin.connect.neb&quot;</span><span class="p">)</span>

<span class="c">#def calc_neb_dist(coords, nimages, dist=True, grad=False):</span>
<span class="c">#    d_left = np.zeros(coords.shape)</span>
<span class="c">#    coords = coords.reshape([-1,nimages])</span>
<span class="c">#    for i in xrange(nimages):</span>
        

<span class="c">#def create_NEB(pot, coords1, coords2, image_density=10, max_images=40,</span>
<span class="c">#                iter_density=15, </span>
<span class="c">#                NEBquenchParams=dict(),</span>
<span class="c">#                interpolator=None,</span>
<span class="c">#                verbose=False, factor=1, parallel=False, ncores=4, **NEBparams):</span>

<div class="viewcode-block" id="NEBDriver"><a class="viewcode-back" href="../../../generated/pygmin.transition_states.NEBDriver.html#pygmin.transition_states.NEBDriver">[docs]</a><span class="k">class</span> <span class="nc">NEBDriver</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; driver class for NEB</span>
<span class="sd">    </span>
<span class="sd">    The NEBDriver wraps calls for NEB from LocalConnect. The driver class is responsible for setting</span>
<span class="sd">    up the initial interpolation and optimizing the band.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    potential :</span>
<span class="sd">        the potential object</span>
<span class="sd">    coords1, coords2 : array</span>
<span class="sd">        the structures to connect with the band</span>
<span class="sd">    k : float, optional</span>
<span class="sd">        the elastic band spring constant </span>
<span class="sd">    max_images : int</span>
<span class="sd">        the maximum number of NEB images</span>
<span class="sd">    image_density : float</span>
<span class="sd">        how many NEB images per unit distance to use.</span>
<span class="sd">    iter_density : float</span>
<span class="sd">        how many optimization iterations per unit distance to use.</span>
<span class="sd">    adjustk_freq : integer</span>
<span class="sd">        frequency to adjust k, set to zero to disable</span>
<span class="sd">    adjustk_tol : float</span>
<span class="sd">        tolerance for adjusting k up or down</span>
<span class="sd">    adjustk_factor : float</span>
<span class="sd">        the multiplicative factor used to adjust k</span>
<span class="sd">    dneb : bool</span>
<span class="sd">        use DNEB (Doubly-Nudged Elastic Band) rather than NEB</span>
<span class="sd">    reinterpolate : integer</span>
<span class="sd">        reinterpolate the path to achieve equidistant spacing every so many steps</span>
<span class="sd">    adaptive_nimages : bool</span>
<span class="sd">        adjust number of images on reinterpolate to match image density</span>
<span class="sd">    adaptive_niter : bool</span>
<span class="sd">        adjust number of iterations if nimages is adjusted</span>
<span class="sd">    factor : int</span>
<span class="sd">        The number of images is multiplied by this factor.  If the number of </span>
<span class="sd">        images is already at it&#39;s maximum, then the number of iterations is </span>
<span class="sd">        multiplied by this factor instead</span>
<span class="sd">    verbose : integer</span>
<span class="sd">    parallel : bool</span>
<span class="sd">        if True, then use class NEBPar to evaluate the image potentials in parallel</span>
<span class="sd">    ncores : int</span>
<span class="sd">        the number of cores to use.  Ignored if parallel is False</span>
<span class="sd">    interpolator : callable, optional</span>
<span class="sd">        the function used to do the path interpolation for the NEB</span>
<span class="sd">    NEBquenchParams : dict</span>
<span class="sd">        parameters passed to the minimizer</span>
<span class="sd">    kwargs : keyword options</span>
<span class="sd">        additional options are passed to the NEB class</span>
<span class="sd">        </span>
<span class="sd">    See Also</span>
<span class="sd">    ---------</span>
<span class="sd">    NEB</span>
<span class="sd">    InterpolatedPath</span>
<span class="sd">        </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">potential</span><span class="p">,</span> <span class="n">coords1</span><span class="p">,</span> <span class="n">coords2</span><span class="p">,</span>
                 <span class="n">k</span> <span class="o">=</span> <span class="mf">100.</span><span class="p">,</span> <span class="n">max_images</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">image_density</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">iter_density</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">NEBquenchParams</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">adjustk_freq</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                 <span class="n">adjustk_tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">adjustk_factor</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">dneb</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">reinterpolate</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">adaptive_nimages</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">adaptive_niter</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">interpolator</span><span class="o">=</span><span class="n">interpolate_linear</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">distance_cart</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ncores</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">potential</span> <span class="o">=</span> <span class="n">potential</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpolator</span> <span class="o">=</span> <span class="n">interpolator</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="n">distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factor</span> <span class="o">=</span> <span class="n">factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_images</span> <span class="o">=</span> <span class="n">max_images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_density</span> <span class="o">=</span> <span class="n">image_density</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter_density</span> <span class="o">=</span> <span class="n">iter_density</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_event</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords1</span> <span class="o">=</span> <span class="n">coords1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords2</span> <span class="o">=</span> <span class="n">coords2</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">reinterpolate</span> <span class="o">=</span> <span class="n">reinterpolate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nebclass</span> <span class="o">=</span> <span class="n">NEB</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_images</span> <span class="o">=</span> <span class="n">adaptive_nimages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_niter</span> <span class="o">=</span> <span class="n">adaptive_niter</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">[</span><span class="s">&quot;adjustk_freq&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">adjustk_freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">[</span><span class="s">&quot;adjustk_tol&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">adjustk_tol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">[</span><span class="s">&quot;adjustk_factor&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">adjustk_factor</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">[</span><span class="s">&quot;dneb&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">dneb</span>
        
        <span class="k">if</span> <span class="n">NEBquenchParams</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">NEBquenchParams</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;tol&#39;</span><span class="p">:</span> <span class="mf">1e-2</span><span class="p">,</span> <span class="s">&#39;maxErise&#39;</span><span class="p">:</span> <span class="mf">100.0</span> <span class="p">}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">quenchParams</span><span class="o">=</span><span class="n">NEBquenchParams</span>
        
        
        <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">[</span><span class="s">&quot;ncores&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">ncores</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nebclass</span> <span class="o">=</span> <span class="n">NEBPar</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prepared</span> <span class="o">=</span> <span class="bp">False</span>
        
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="NEBDriver.params"><a class="viewcode-back" href="../../../generated/pygmin.transition_states.NEBDriver.params.html#pygmin.transition_states.NEBDriver.params">[docs]</a>    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">NEBDriver</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="sd">&#39;&#39;&#39; return the the parameters of current instance &#39;&#39;&#39;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&quot;k&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">k</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&quot;image_density&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">image_density</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&quot;max_images&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">max_images</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&quot;iter_density&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">iter_density</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&quot;reinterpolate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">reinterpolate</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&quot;adaptive_nimages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">adaptive_images</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&quot;adaptive_niter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">adaptive_niter</span>
        
        <span class="n">params</span><span class="p">[</span><span class="s">&quot;verbose&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">verbose</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&quot;NEBquenchParams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">quenchParams</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c"># factor is not here, todo, move this out of constuctor</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&quot;interpolator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">interpolator</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&quot;distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">distance</span>
        
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;ncores&quot;</span><span class="p">):</span>
            <span class="n">params</span><span class="p">[</span><span class="s">&quot;parallel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
         
        <span class="k">return</span> <span class="n">params</span>
    </div>
<div class="viewcode-block" id="NEBDriver.prepare"><a class="viewcode-back" href="../../../generated/pygmin.transition_states.NEBDriver.prepare.html#pygmin.transition_states.NEBDriver.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepared</span><span class="o">=</span><span class="bp">True</span>
           
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">nimages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps_total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span>

        <span class="n">energies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">potential</span><span class="o">.</span><span class="n">getEnergy</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            
        <span class="n">distances</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>           
            <span class="n">distances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]))</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">update_event</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> <span class="n">energies</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">energies</span><span class="p">),</span>
                       <span class="n">distances</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">distances</span><span class="p">),</span> <span class="n">stepnum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_total</span><span class="p">,</span>
                       <span class="n">rms</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_k</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="s">&quot;initial&quot;</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="NEBDriver.run"><a class="viewcode-back" href="../../../generated/pygmin.transition_states.NEBDriver.run.html#pygmin.transition_states.NEBDriver.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="c">#determine the number of iterations                </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepared</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>
            
        <span class="n">quenchParams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quenchParams</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">nimages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="c">#if nimages is already max_images then increasing the number</span>
        <span class="c">#of images with factor will have no effect.  so double the number of steps instead</span>
        <span class="n">niter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_density</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nimages</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span> <span class="o">&gt;</span> <span class="mf">1.</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nimages</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_images</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_images</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">niter</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span>
        
        <span class="n">quenchParams</span><span class="p">[</span><span class="s">&quot;nsteps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">niter</span>    
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>    
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;    NEB: nimages   </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nimages</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;    NEB: nsteps    </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">niter</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;    NEB: verbosity </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
                
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reinterpolate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">quenchParams</span><span class="p">[</span><span class="s">&quot;nsteps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reinterpolate</span><span class="p">,</span> <span class="n">niter</span><span class="p">)</span>   
        
        <span class="bp">self</span><span class="o">.</span><span class="n">niter</span> <span class="o">=</span> <span class="n">niter</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_k</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>       
            <span class="n">neb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nebclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                      <span class="n">quenchParams</span><span class="o">=</span><span class="n">quenchParams</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                      <span class="n">distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neb</span> <span class="o">=</span> <span class="n">neb</span>
            
            <span class="n">neb</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_event</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">neb</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_k</span><span class="o">=</span><span class="n">neb</span><span class="o">.</span><span class="n">k</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">path</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">steps_total</span> <span class="o">+=</span> <span class="n">res</span><span class="o">.</span><span class="n">nsteps</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_total</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">niter</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_total</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">path</span>
            
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;NEB finished after </span><span class="si">%d</span><span class="s"> steps, rms </span><span class="si">%e</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">nsteps</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">rms</span><span class="p">))</span>
                    
                <span class="bp">self</span><span class="o">.</span><span class="n">_send_finish_event</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">neb</span>
            
            <span class="n">distances</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>           
                <span class="n">distances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">res</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reinterpolate</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">distances</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_niter</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">niter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_density</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span> <span class="o">&gt;</span> <span class="mf">1.</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_images</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_images</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">niter</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span>    
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;NEB reinterpolating path, </span><span class="si">%d</span><span class="s"> images, niter is </span><span class="si">%d</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">niter</span><span class="p">))</span>
        
        </div>
<div class="viewcode-block" id="NEBDriver.generate_path"><a class="viewcode-back" href="../../../generated/pygmin.transition_states.NEBDriver.generate_path.html#pygmin.transition_states.NEBDriver.generate_path">[docs]</a>    <span class="k">def</span> <span class="nf">generate_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords1</span><span class="p">,</span> <span class="n">coords2</span><span class="p">):</span>
        <span class="c">#determine the number of images to use</span>
        <span class="n">dist</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">coords1</span><span class="p">,</span> <span class="n">coords2</span><span class="p">)</span>
        <span class="n">dist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
        <span class="n">nimages</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_density</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_images</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nimages</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nimages</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_images</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">InterpolatedPath</span><span class="p">(</span><span class="n">coords1</span><span class="p">,</span> <span class="n">coords2</span><span class="p">,</span> <span class="n">nimages</span><span class="p">,</span> <span class="n">interpolator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolator</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">path</span><span class="p">]</span>
</div>
    <span class="k">def</span> <span class="nf">_reinterpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">distances</span><span class="p">):</span>
        <span class="n">acc_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>
        <span class="n">nimages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_images</span><span class="p">:</span>
            <span class="n">nimages</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">acc_dist</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_density</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_images</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nimages</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">nimages</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_images</span><span class="p">))</span>
            
        <span class="n">newpath</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">newpath</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        
        <span class="n">icur</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">s_cur</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">s_next</span><span class="o">=</span><span class="n">distances</span><span class="p">[</span><span class="n">icur</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nimages</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">acc_dist</span> <span class="o">/</span> <span class="p">(</span><span class="n">nimages</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="n">s_next</span><span class="p">:</span>
                <span class="n">icur</span><span class="o">+=</span><span class="mi">1</span>
                <span class="n">s_cur</span> <span class="o">=</span> <span class="n">s_next</span>
                <span class="n">s_next</span><span class="o">+=</span><span class="n">distances</span><span class="p">[</span><span class="n">icur</span><span class="p">]</span>
            
            <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_cur</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">s_next</span> <span class="o">-</span> <span class="n">s_cur</span><span class="p">)</span>
            <span class="n">newpath</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolator</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">icur</span><span class="p">],</span> <span class="n">path</span><span class="p">[</span><span class="n">icur</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">))</span>
        <span class="n">newpath</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">newpath</span>
       
    <span class="k">def</span> <span class="nf">_process_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">energies</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">distances</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stepnum</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rms</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_event</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
                       <span class="n">distances</span><span class="o">=</span><span class="n">distances</span><span class="p">,</span> <span class="n">stepnum</span><span class="o">=</span><span class="n">stepnum</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_total</span><span class="p">,</span>
                       <span class="n">rms</span><span class="o">=</span><span class="n">rms</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">neb</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="s">&quot;update&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_send_finish_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>           
            <span class="n">distances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">res</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_event</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">energies</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span>
                       <span class="n">distances</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">distances</span><span class="p">),</span> <span class="n">stepnum</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">nsteps</span><span class="p">,</span>
                       <span class="n">rms</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">rms</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">neb</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="s">&quot;final&quot;</span><span class="p">)</span>
        </div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../../np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">pygmin 0.1 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Victor Rühle, Jacob Stevenson.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>